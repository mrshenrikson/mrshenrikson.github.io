<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Mein Klavier â€“ Oktave (C1..C3) mit Umschalter</title>
<style>
  :root{ --wW:64px; --bW:46px; --wH:140px; --bH:90px; --gap:6px; --mark:#f6b73c; }
  *{box-sizing:border-box}
  body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:#f7f7fb;color:#111}
  h1{font-size:20px;margin:14px}
  .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:0 14px 8px}
  .btn{background:#222;color:#fff;border:none;border-radius:8px;padding:10px 14px;touch-action:manipulation}
  .btn:disabled{opacity:.6}
  .label{padding:6px 10px;border-radius:8px;background:#e9eefb;font-weight:600}
  .board{padding:12px}
  .piano{overflow-x:auto;-webkit-overflow-scrolling:touch;border:1px solid #ddd;border-radius:12px;background:#ececf4;padding:12px}
  .row{display:flex;gap:var(--gap);align-items:flex-end;min-width:calc(7*var(--wW)+6*var(--gap))}
  .row+.row{margin-top:8px}
  .key{display:inline-flex;align-items:flex-end;justify-content:center;font-weight:600;font-size:14px;border-radius:8px;user-select:none;touch-action:manipulation}
  .white{width:var(--wW);height:var(--wH);background:#fff;border:2px solid #333;color:#111}
  .black{width:var(--bW);height:var(--bH);background:#1b1b1b;border:2px solid #000;color:#fff}
  .spacer{width:var(--wW)}
  .active{background:linear-gradient(#a6c8ff,#5ea0ff)!important;color:#000!important}
  .chord{outline:3px solid var(--mark);outline-offset:-3px}
  footer{padding:0 14px 18px;color:#666;font-size:13px}
  .status{margin:10px 14px 0;color:#555;font-size:13px}
  .probe{margin-left:auto}
</style>
</head>
<body>
<h1>ðŸŽ¹ Mein Klavier (eine Oktave, umschaltbar C1â†”C2â†”C3)</h1>

<div class="controls">
  <button id="prevOct" class="btn" title="vorige Oktave">âŸµ</button>
  <span id="octLabel" class="label">Oktave: C1</span>
  <button id="nextOct" class="btn" title="nÃ¤chste Oktave">âŸ¶</button>
  <label style="margin-left:8px;"><input id="minor" type="checkbox"> Moll-DreiklÃ¤nge</label>
  <button id="probe" class="btn probe" title="Audio-Test">ðŸ”Š Audio-Probe</button>
</div>
<div class="status" id="status">Bereit.</div>

<div class="board">
  <div class="piano" id="piano">
    <!-- Reihe 1: schwarze Tasten -->
    <div class="row" id="rowBlack">
      <div class="spacer"></div>
      <button class="key black" data-semi="1">C#</button>
      <button class="key black" data-semi="3">D#</button>
      <div class="spacer"></div>
      <button class="key black" data-semi="6">F#</button>
      <button class="key black" data-semi="8">G#</button>
      <button class="key black" data-semi="10">A#</button>
      <div class="spacer"></div>
    </div>
    <!-- Reihe 2: weiÃŸe Tasten -->
    <div class="row" id="rowWhite">
      <button class="key white" data-semi="0">C</button>
      <button class="key white" data-semi="2">D</button>
      <button class="key white" data-semi="4">E</button>
      <button class="key white" data-semi="5">F</button>
      <button class="key white" data-semi="7">G</button>
      <button class="key white" data-semi="9">A</button>
      <button class="key white" data-semi="11">B</button>
    </div>
  </div>
</div>

<footer>
  Tipp auf eine Taste: 2 s Einzeltton â†’ 1 s Pause â†’ 3 s Dreiklang (Grundstellung; Dur/Moll schaltbar).  
  Leise bis moderat Ã¼ben; bei Kratzen â†’ Pause. ðŸ’™
</footer>

<script>
(()=>{
/* ===== Basis & Anzeige ===== */
const statusEl = document.getElementById('status');
const log = (msg)=>{ statusEl.textContent = msg; };

/* User-Site auf Root: BASE = '/'  */
const BASE = '/';

/* Dateiendungen, die ausprobiert werden (in dieser Reihenfolge) */
const EXT_CANDIDATES = ['m4a','mp3','mp4','wav'];

/* Oktav-Umschalter */
const LOWEST_OCT = 1;   // C1
const HIGHEST_OCT = 3;  // C3
let currentOct = 1;

const lbl = document.getElementById('octLabel');
const prevBtn = document.getElementById('prevOct');
const nextBtn = document.getElementById('nextOct');
const minor   = document.getElementById('minor');
const probeBtn= document.getElementById('probe');

function updateLabel(){
  lbl.textContent = `Oktave: C${currentOct}`;
  prevBtn.disabled = (currentOct===LOWEST_OCT);
  nextBtn.disabled = (currentOct===HIGHEST_OCT);
  log(`Oktave gewechselt: C${currentOct}`);
}
prevBtn.addEventListener('click', ()=>{ if(currentOct>LOWEST_OCT){ currentOct--; updateLabel(); }});
nextBtn.addEventListener('click', ()=>{ if(currentOct<HIGHEST_OCT){ currentOct++; updateLabel(); }});
updateLabel();

/* ===== Namen / Dateinamen (C1s-Schema) ===== */
const NAMES = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
function noteName(oct, semi){
  const base = NAMES[semi];
  return base.includes('#') ? base[0] + oct + 's' : base + oct;
}

/* ===== Audio-Loader (robust, mit Fallbacks & Samples/Samples) ===== */
async function resolveSrc(note){
  const folders = ['samples','Samples']; // falls Ordner versehentlich groÃŸ geschrieben wurde
  for(const folder of folders){
    for(const ext of EXT_CANDIDATES){
      const url = `${BASE}${folder}/${note}.${ext}`;
      // Probe laden
      const a = new Audio(url);
      a.preload = 'auto';
      const ok = new Promise(res=>a.addEventListener('canplaythrough', ()=>res(true), {once:true}));
      const err= new Promise(res=>a.addEventListener('error', ()=>res(false), {once:true}));
      const timed = Promise.race([ok,err,new Promise(res=>setTimeout(()=>res(false),1200))]);
      const canPlay = await timed;
      if(canPlay){ return url; }
    }
  }
  return null;
}

async function playSample(note, durSec=2.0){
  const src = await resolveSrc(note);
  if(!src){ log(`âš ï¸ Datei fehlt: ${note} (erwartet in /samples als m4a/mp3/mp4/wav)`); return; }
  log(`â–¶ï¸Ž ${note} â€“ ${src.split('/').slice(-2).join('/')}`);
  const a = new Audio(src);
  a.preload = 'auto';
  a.playsInline = true;
  a.currentTime = 0;
  a.play().catch(()=>{});
  if(durSec>0){
    setTimeout(()=>{ try{ a.pause(); a.remove(); }catch(e){} }, Math.round(durSec*1000));
  }
}

/* ===== Visuelles Feedback ===== */
function flash(el, cls, ms){ el.classList.add(cls); setTimeout(()=>el.classList.remove(cls), ms); }
const keyElFor = semi => document.querySelector(`.key[data-semi="${semi}"]`);

/* ===== Klick-Ablauf: Note 2s â†’ Pause 1s â†’ Akkord 3s ===== */
const busy = new Set();

document.body.addEventListener('click', async (e)=>{
  const btn = e.target.closest('.key');
  if(!btn) return;

  const semi = parseInt(btn.dataset.semi, 10);
  if(busy.has(semi)) return;
  busy.add(semi);

  const root = noteName(currentOct, semi);

  // 1) Einzeltton 2 s
  flash(btn,'active',400);
  await playSample(root, 2.0);

  // 2) 1 s Pause
  setTimeout(async ()=>{
    // 3) Dreiklang 3 s (Grundstellung Dur/Moll)
    const ints = (minor && minor.checked) ? [0,3,7] : [0,4,7];
    ints.forEach(s=>{
      const k = keyElFor((semi + s) % 12);
      if(k) flash(k,'chord',1000);
    });
    const notes = ints.map(s => noteName(currentOct, (semi + s) % 12));
    for(const n of notes){ playSample(n, 3.0); }
    setTimeout(()=>busy.delete(semi), 3100);
  }, 1000); // Pause
});

/* ===== Audio-Probe ===== */
probeBtn.addEventListener('click', async ()=>{
  const test = noteName(currentOct, 0); // C der aktuellen Oktave
  await playSample(test, 1.2);
});
})();
</script>
</body>
</html>
