<script>
(()=>{
/* ——— Einstellungen ——— */
const LOWEST_OCT = 1;   // C1
const HIGHEST_OCT = 3;  // C3
let currentOct = 1;     // Startansicht: C1
const EXT = 'm4a';      // <-- wir laden .mp4 statt .mp3

/* ——— Namen / Filenamen ——— */
const NAMES = ['C','Cs','D','Ds','E','F','Fs','G','Gs','A','As','B'];
function noteName(oct, semi){ return NAMES[semi] + oct; } // z.B. E2 = "E2"

/* ——— Sample-Player (HTMLAudio: .mp4) ——— */
const cache = new Map(); // "C2" -> Audio-Master; pro Play klonen
function getAudio(note){ // note z.B. "Fs1"
  const key = note.toUpperCase();
  if(!cache.has(key)){
    const a = new Audio(`samples/${key}.${EXT}`);
    a.preload = 'auto';
    cache.set(key, a);
  }
  return cache.get(key).cloneNode(true); // für paralleles Abspielen
}
function playSample(note, durSec=2.0){
  const a = getAudio(note);
  a.currentTime = 0;
  a.play().catch(()=>{}); // iOS spielt nach User-Tap
  if(durSec>0){
    setTimeout(()=>{ try{ a.pause(); a.currentTime = 0; }catch(e){} }, Math.round(durSec*1000));
  }
}

/* ——— UI / Oktav-Umschalter ——— */
const lbl = document.getElementById('octLabel');
const prevBtn = document.getElementById('prevOct');
const nextBtn = document.getElementById('nextOct');
const minor = document.getElementById('minor');

function updateLabel(){
  lbl.textContent = `Oktave: C${currentOct}`;
  prevBtn.disabled = (currentOct===LOWEST_OCT);
  nextBtn.disabled = (currentOct===HIGHEST_OCT);
}
updateLabel();
prevBtn.addEventListener('click', ()=>{ if(currentOct>LOWEST_OCT){ currentOct--; updateLabel(); }});
nextBtn.addEventListener('click', ()=>{ if(currentOct<HIGHEST_OCT){ currentOct++; updateLabel(); }});

/* ——— Visuelles Feedback ——— */
function flash(el, cls, ms){ el.classList.add(cls); setTimeout(()=>el.classList.remove(cls), ms); }
function keyElFor(oct, semi){ return document.querySelector(`.key[data-semi="${semi}"]`); }

/* ——— Klick-Ablauf ———
   1) Einzeltton 2 s
   2) Pause 1 s
   3) Dreiklang (Grundstellung) 3 s
*/
const busy = new Set(); // blockt Doppelstarts pro semitone bis Sequenz fertig ist

document.body.addEventListener('click', (e)=>{
  const btn = e.target.closest('.key');
  if(!btn) return;

  const semi = parseInt(btn.dataset.semi, 10);
  if(busy.has(semi)) return;
  busy.add(semi);

  const rootNote = noteName(currentOct, semi); // z.B. "E2"

  // 1) Einzeltton 2s
  flash(btn, 'active', 400);
  playSample(rootNote, 2.0);

  // 2) Pause 1s
  const PAUSE_MS = 1000;

  // 3) Dreiklang 3s (Grundstellung, Dur/Moll)
  setTimeout(()=>{
    const ints = (minor && minor.checked) ? [0,3,7] : [0,4,7];
    // visuell markieren
    ints.forEach(s=>{
      const k = keyElFor(currentOct, (semi + s) % 12);
      if(k) flash(k, 'chord', 1000);
    });
    // Notennamen der Akkordtöne bilden und 3s abspielen
    const notes = ints.map(s => noteName(currentOct, (semi + s) % 12));
    notes.forEach(n => playSample(n, 3.0));

    // nach 3s Akkord wieder freigeben
    setTimeout(()=>busy.delete(semi), 3100);
  }, 2000 + PAUSE_MS); // 2s Ton + 1s Pause
});
})();
</script>
