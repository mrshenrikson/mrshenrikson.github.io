<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Mein Klavier â€“ Oktave umschaltbar (C1..C3)</title>
<style>
  :root{
    --wW:64px; --bW:46px; --wH:140px; --bH:90px; --gap:6px;
    --accent:#5ea0ff; --mark:#f6b73c;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:#f7f7fb;color:#111}
  h1{font-size:20px;margin:14px}
  .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:0 14px 8px}
  .btn{background:#222;color:#fff;border:none;border-radius:8px;padding:10px 14px;touch-action:manipulation}
  .btn:disabled{opacity:.6}
  .oct-wrap{display:flex;gap:8px;align-items:center}
  .label{padding:6px 10px;border-radius:8px;background:#e9eefb;font-weight:600}
  .board{padding:12px}
  .piano{overflow-x:auto;-webkit-overflow-scrolling:touch;border:1px solid #ddd;border-radius:12px;background:#ececf4;padding:12px}
  .row{display:flex;gap:var(--gap);align-items:flex-end;min-width:calc(7*var(--wW)+6*var(--gap))}
  .row+.row{margin-top:8px}
  .key{display:inline-flex;align-items:flex-end;justify-content:center;font-weight:600;font-size:14px;border-radius:8px;user-select:none;touch-action:manipulation}
  .white{width:var(--wW);height:var(--wH);background:#fff;border:2px solid #333;color:#111}
  .black{width:var(--bW);height:var(--bH);background:#1b1b1b;border:2px solid #000;color:#fff}
  .spacer{width:var(--wW)}
  .active{background:linear-gradient(#a6c8ff,#5ea0ff)!important;color:#000!important}
  .chord{outline:3px solid var(--mark);outline-offset:-3px}
  footer{padding:0 14px 18px;color:#666;font-size:13px}
</style>
</head>
<body>
<h1>ðŸŽ¹ Mein Klavier (eine Oktave, umschaltbar C1â†”C2â†”C3)</h1>

<div class="controls">
  <div class="oct-wrap">
    <button id="prevOct" class="btn" title="vorige Oktave">âŸµ</button>
    <span id="octLabel" class="label">Oktave: C1</span>
    <button id="nextOct" class="btn" title="nÃ¤chste Oktave">âŸ¶</button>
  </div>
  <label><input id="minor" type="checkbox"> Moll-DreiklÃ¤nge</label>
</div>

<div class="board">
  <div class="piano" id="piano">
    <!-- Reihe 1: schwarze Tasten -->
    <div class="row" id="rowBlack">
      <div class="spacer"></div>
      <button class="key black" data-semi="1">C#</button>
      <button class="key black" data-semi="3">D#</button>
      <div class="spacer"></div>
      <button class="key black" data-semi="6">F#</button>
      <button class="key black" data-semi="8">G#</button>
      <button class="key black" data-semi="10">A#</button>
      <div class="spacer"></div>
    </div>
    <!-- Reihe 2: weiÃŸe Tasten -->
    <div class="row" id="rowWhite">
      <button class="key white" data-semi="0">C</button>
      <button class="key white" data-semi="2">D</button>
      <button class="key white" data-semi="4">E</button>
      <button class="key white" data-semi="5">F</button>
      <button class="key white" data-semi="7">G</button>
      <button class="key white" data-semi="9">A</button>
      <button class="key white" data-semi="11">B</button>
    </div>
  </div>
</div>

<footer>
  Tipp auf eine Taste: 2 s Einzeltton â†’ 1 s Pause â†’ 3 s Dreiklang (Grundstellung; Dur/Moll schaltbar).  
  Leise bis moderat Ã¼ben; bei Kratzen â†’ Pause. ðŸ’™
</footer>

<script>
(()=>{
/* â€”â€”â€”â€”â€” Einstellungen â€”â€”â€”â€”â€” */
const LOWEST_OCT = 1;   // C1
const HIGHEST_OCT = 3;  // C3
let currentOct = 1;     // Startansicht: C1

/* â€”â€”â€”â€”â€” Hilfen: Notennamen/Filenames â€”â€”â€”â€”â€” */
const NAMES = ['C','Cs','D','Ds','E','F','Fs','G','Gs','A','As','B'];
function noteName(oct, semi){ return NAMES[semi] + oct; } // z.B. semi=1, oct=2 -> "Cs2"

/* â€”â€”â€”â€”â€” Sample-Player (AudioTag) â€”â€”â€”â€”â€” */
const cache = new Map(); // "C2" -> Audio (Master); pro Play wird geklont
function getAudio(note){ // note z.B. "Fs1"
  const key = note.toUpperCase();
  if(!cache.has(key)){
    const a = new Audio(`samples/${key}.mp3`);
    a.preload = 'auto';
    cache.set(key, a);
  }
  // Klon fÃ¼r gleichzeitiges Abspielen
  return cache.get(key).cloneNode(true);
}
function playSample(note, durSec=2.0){
  const a = getAudio(note);
  a.currentTime = 0;
  a.play().catch(()=>{}); // iOS spielt nach User-Tap
  if(durSec>0){
    setTimeout(()=>{ try{ a.pause(); a.currentTime = 0; }catch(e){} }, Math.round(durSec*1000));
  }
}

/* â€”â€”â€”â€”â€” UI/State â€”â€”â€”â€”â€” */
const lbl = document.getElementById('octLabel');
const prevBtn = document.getElementById('prevOct');
const nextBtn = document.getElementById('nextOct');
const minor = document.getElementById('minor');

function updateLabel(){
  lbl.textContent = `Oktave: C${currentOct}`;
  prevBtn.disabled = (currentOct===LOWEST_OCT);
  nextBtn.disabled = (currentOct===HIGHEST_OCT);
}
updateLabel();

prevBtn.addEventListener('click', ()=>{ if(currentOct>LOWEST_OCT){ currentOct--; updateLabel(); }});
nextBtn.addEventListener('click', ()=>{ if(currentOct<HIGHEST_OCT){ currentOct++; updateLabel(); }});

/* â€”â€”â€”â€”â€” Visuelles Feedback â€”â€”â€”â€”â€” */
function flash(el, cls, ms){ el.classList.add(cls); setTimeout(()=>el.classList.remove(cls), ms); }
function keyElFor(oct, semi){
  // findet die sichtbare Taste dieser Oktave: gleiche semitone-Buttons
  return document.querySelector(`.key[data-semi="${semi}"]`);
}

/* â€”â€”â€”â€”â€” Ablauf beim Tasten-Tap â€”â€”â€”â€”â€”
   1) Einzeltton 2s
   2) 1s Pause
   3) Dreiklang (Grundstellung) 3s
*/
const busy = new Set(); // verhindert Doppelstarts pro semi bis Sequenz fertig ist

document.body.addEventListener('click', (e)=>{
  const btn = e.target.closest('.key');
  if(!btn) return;

  const semi = parseInt(btn.dataset.semi, 10);
  if(busy.has(semi)) return;
  busy.add(semi);

  const rootNote = noteName(currentOct, semi); // z.B. "E2"

  // 1) Einzeltton 2 s
  flash(btn, 'active', 400);
  playSample(rootNote, 2.0);

  // 2) Pause 1 s (nach Ton-Ende)
  const PAUSE_MS = 1000;

  // 3) Dreiklang 3 s (Grundstellung, je nach Dur/Moll)
  setTimeout(()=>{
    const ints = minor && minor.checked ? [0,3,7] : [0,4,7];
    // visuelle Markierung der AkkordtÃ¶ne
    ints.forEach(s=>{
      const k = keyElFor(currentOct, (semi + s) % 12);
      if(k) flash(k, 'chord', 900);
    });
    // passende Sample-Namen bilden (gleiches Oktav-Fundament, echte Grundstellung)
    const notes = ints.map(s => noteName(currentOct, (semi + s) % 12));
    notes.forEach(n => playSample(n, 3.0));

    // nach ~3 s ist die Sequenz durch â€“ freigeben
    setTimeout(()=>busy.delete(semi), 3100);
  }, 2000 + PAUSE_MS); // 2s Ton + 1s Pause
});
})();
</script>
</body>
</html>
