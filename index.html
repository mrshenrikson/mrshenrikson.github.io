<script>
(()=>{
// ---------- Audio-Grundlage ----------
let ctx=null, master=null, started=false;
function m2f(m){ return 440*Math.pow(2,(m-69)/12); }
async function ensureCtx(){
  if(!ctx){ ctx=new (window.AudioContext||window.webkitAudioContext)({latencyHint:'interactive'}); }
  if(ctx.state==='suspended') await ctx.resume();
}
async function unlock(){
  await ensureCtx();
  if(!master){ master=ctx.createGain(); master.gain.value=0.9; master.connect(ctx.destination); }
  // 1-Sample-Stille abspielen → iOS-Unlock
  const b=ctx.createBuffer(1,1,ctx.sampleRate), s=ctx.createBufferSource();
  s.buffer=b; s.connect(master); s.start(0);
  started=true; setUI();
}
function setUI(){
  const btn=document.getElementById('start');
  if(btn){ btn.disabled=true; btn.textContent='Audio aktiv'; }
}

// ---------- Tonerzeugung ----------
function play(midi, dur=1.0){
  if(!started || !ctx) return;
  const t=ctx.currentTime, o=ctx.createOscillator(), g=ctx.createGain();
  o.type='triangle';
  o.frequency.value=m2f(midi);
  g.gain.setValueAtTime(0,t);
  g.gain.linearRampToValueAtTime(1,t+0.01);
  g.gain.linearRampToValueAtTime(0,t+dur);
  o.connect(g); g.connect(master);
  o.start(t); o.stop(t+dur+0.05);
}
function playChord(root, ints, dur=2.0){ ints.forEach(s=>play(root+s, dur)); }

function flash(el, cls, ms){ el.classList.add(cls); setTimeout(()=>el.classList.remove(cls), ms); }

// ---------- Buttons: Start & Test ----------
const startBtn = document.getElementById('start');
if(startBtn){ startBtn.addEventListener('click', unlock); }

const testBtn = document.getElementById('beep');
if(testBtn){
  testBtn.addEventListener('click', async ()=>{
    if(!started) await unlock();
    play(69, 0.6); // A4 kurzer Testton
  });
}

// ---------- Klicklogik ----------
const minor = document.getElementById('minor');
const busyByMidi = new Set();

document.body.addEventListener('click', async (e)=>{
  const btn = e.target.closest('.key');
  if(!btn) return;
  if(!started) await unlock();

  const midi = parseInt(btn.dataset.midi,10);
  if(busyByMidi.has(midi)) return;
  busyByMidi.add(midi);

  // 1) Einzeltton 1 s
  flash(btn,'active', 350);
  play(midi, 1.0);

  // 2) Nach 1 s Pause → 3) Dreiklang 2 s
  setTimeout(()=>{
    const ints = (minor && minor.checked) ? [0,3,7] : [0,4,7]; // Grundstellung
    ints.forEach(semi=>{
      const k = document.querySelector(`.key[data-midi="${midi+semi}"]`);
      if(k) flash(k,'chord', 700);
    });
    playChord(midi, ints, 2.0); // <-- jetzt 2 Sekunden
    setTimeout(()=>busyByMidi.delete(midi), 2100);
  }, 2000); // 1s Ton + 1s Pause = Start bei 2s
});
})();
</script>
