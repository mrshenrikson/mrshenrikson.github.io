<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Virtuelles Klavier ‚Äì Sofort‚ÄëModus</title>
<style>
  :root{ --wW:64px; --bW:46px; --wH:140px; --bH:90px; --gap:6px; --mark:#f6b73c; }
  *{box-sizing:border-box}
  body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:#f7f7fb;color:#111}
  h1{font-size:20px;margin:14px}
  .controls{display:flex;gap:10px;align-items:center;margin:0 14px 8px;flex-wrap:wrap}
  .btn{background:#1f6feb;color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:600}
  .btn.secondary{background:#6e7781}
  .label{padding:6px 10px;border-radius:10px;background:#e9eefb;font-weight:600}
  .board{padding:12px}
  .piano{border:1px solid #ddd;border-radius:12px;background:#ececf4;padding:12px}
  .row{display:flex;gap:var(--gap);align-items:flex-end;min-width:calc(14*var(--wW)+13*var(--gap))}
  .row+.row{margin-top:8px}
  .key{display:inline-flex;align-items:flex-end;justify-content:center;font-weight:600;font-size:14px;border-radius:8px;user-select:none;touch-action:manipulation}
  .white{width:var(--wW);height:var(--wH);background:#fff;border:2px solid #333;color:#111}
  .black{width:var(--bW);height:var(--bH);background:#1b1b1b;border:2px solid #000;color:#fff}
  .spacer{width:var(--wW)}
  .active{background:linear-gradient(#a6c8ff,#5ea0ff)!important;color:#000!important}
  .chord{outline:3px solid var(--mark);outline-offset:-3px}
  .status{margin:6px 14px 12px;color:#555;font-size:13px}
</style>
</head>
<body>
<h1>üéπ Virtuelles Klavier (2 Oktaven ‚Ä¢ Einzelt√∂ne + Akkord‚ÄëSamples)</h1>

<div class="controls">
  <button id="instant" class="btn" title="Sofort‚ÄëModus umschalten">‚è±Ô∏è Sofort‚ÄëModus: AUS</button>
  <label><input id="minor" type="checkbox"> Moll‚ÄëDreikl√§nge</label>
  <button id="probe" class="btn secondary">üîä Probe</button>
  <span class="label" id="flowLabel">Ablauf: 2‚ÄØs Ton ‚Üí 1‚ÄØs Pause ‚Üí 3‚ÄØs Akkord</span>
</div>
<div class="status" id="status">Bereit.</div>

<div class="board">
  <div class="piano">
    <!-- Schwarze Tasten (2 Oktaven) -->
    <div class="row">
      <div class="spacer"></div>
      <button class="key black" data-note="C1s">C#</button>
      <button class="key black" data-note="D1s">D#</button>
      <div class="spacer"></div>
      <button class="key black" data-note="F1s">F#</button>
      <button class="key black" data-note="G1s">G#</button>
      <button class="key black" data-note="A1s">A#</button>
      <div class="spacer"></div>
      <button class="key black" data-note="C2s">C#</button>
      <button class="key black" data-note="D2s">D#</button>
      <div class="spacer"></div>
      <button class="key black" data-note="F2s">F#</button>
      <button class="key black" data-note="G2s">G#</button>
      <button class="key black" data-note="A2s">A#</button>
      <div class="spacer"></div>
    </div>
    <!-- Wei√üe Tasten (2 Oktaven) -->
    <div class="row">
      <button class="key white" data-note="C1">C</button>
      <button class="key white" data-note="D1">D</button>
      <button class="key white" data-note="E1">E</button>
      <button class="key white" data-note="F1">F</button>
      <button class="key white" data-note="G1">G</button>
      <button class="key white" data-note="A1">A</button>
      <button class="key white" data-note="B1">B</button>

      <button class="key white" data-note="C2">C</button>
      <button class="key white" data-note="D2">D</button>
      <button class="key white" data-note="E2">E</button>
      <button class="key white" data-note="F2">F</button>
      <button class="key white" data-note="G2">G</button>
      <button class="key white" data-note="A2">A</button>
      <button class="key white" data-note="B2">B</button>
    </div>
  </div>
</div>

<script>
const statusEl = document.getElementById('status');
const flowLabel = document.getElementById('flowLabel');
const instantBtn = document.getElementById('instant');
const log = m => statusEl.textContent = m;

const BASE = '/samples/';
const exts = ['m4a','mp3']; // m4a zuerst, dann mp3
const busy = new Set();
let instantMode = false;

// Sofort‚ÄëModus Umschalter
instantBtn.addEventListener('click', ()=>{
  instantMode = !instantMode;
  instantBtn.textContent = instantMode ? '‚è±Ô∏è Sofort‚ÄëModus: AN' : '‚è±Ô∏è Sofort‚ÄëModus: AUS';
  flowLabel.textContent = instantMode
    ? 'Ablauf: 2‚ÄØs Grundton + Akkord gleichzeitig'
    : 'Ablauf: 2‚ÄØs Ton ‚Üí 1‚ÄØs Pause ‚Üí 3‚ÄØs Akkord';
});

async function play(fileBase, dur=0){
  for(const ext of exts){
    const src = BASE + fileBase + '.' + ext;
    const a = new Audio(src);
    try{
      await a.play();
      if(dur>0){
        setTimeout(()=>{ try{ a.pause(); a.remove(); }catch(e){} }, Math.round(dur*1000));
      }
      log('‚ñ∂Ô∏é ' + src.split('/').pop());
      return true;
    }catch(e){ /* n√§chste Endung versuchen */ }
  }
  log('‚ö†Ô∏è Datei fehlt: ' + fileBase + '.(' + exts.join('/') + ')');
  return false;
}

document.querySelectorAll('.key').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    const note = btn.dataset.note;                  // z.‚ÄØB. "C1" oder "C1s"
    if(busy.has(note)) return;
    busy.add(note);

    const isMinor = document.getElementById('minor').checked;
    const chordFile = note + (isMinor ? '_moll' : '_dur');

    btn.classList.add('active');

    if(instantMode){
      // Sofort: Grundton + Akkord gleichzeitig, 2 s
      btn.classList.add('chord');
      play(note, 2);
      play(chordFile, 2);
      setTimeout(()=>{ btn.classList.remove('active','chord'); busy.delete(note); }, 2050);
    }else{
      // Standard: 2 s Ton ‚Üí 1 s Pause ‚Üí 3 s Akkord
      await play(note, 2);
      setTimeout(async ()=>{
        btn.classList.add('chord');
        await play(chordFile, 3);
        btn.classList.remove('active','chord');
        busy.delete(note);
      }, 1000);
    }
  });
});

// Probe
document.getElementById('probe').addEventListener('click', ()=> play('C1', 1.2));
</script>
</body>
</html>
