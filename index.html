<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Mein Klavier â€“ 2 Oktaven mit Umschalter</title>
<style>
  :root{ --wW:64px; --bW:46px; --wH:140px; --bH:90px; --gap:6px; --mark:#f6b73c; }
  *{box-sizing:border-box}
  body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:#f7f7fb;color:#111}
  h1{font-size:20px;margin:14px}
  .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:0 14px 8px}
  .btn{background:#222;color:#fff;border:none;border-radius:8px;padding:10px 14px;touch-action:manipulation}
  .btn:disabled{opacity:.6}
  .label{padding:6px 10px;border-radius:8px;background:#e9eefb;font-weight:600}
  .board{padding:12px}
  .piano{overflow-x:auto;-webkit-overflow-scrolling:touch;border:1px solid #ddd;border-radius:12px;background:#ececf4;padding:12px}
  .row{display:flex;gap:var(--gap);align-items:flex-end;min-width:calc(14*var(--wW)+13*var(--gap))}
  .row+.row{margin-top:8px}
  .key{display:inline-flex;align-items:flex-end;justify-content:center;font-weight:600;font-size:14px;border-radius:8px;user-select:none;touch-action:manipulation}
  .white{width:var(--wW);height:var(--wH);background:#fff;border:2px solid #333;color:#111}
  .black{width:var(--bW);height:var(--bH);background:#1b1b1b;border:2px solid #000;color:#fff}
  .spacer{width:var(--wW)}
  .active{background:linear-gradient(#a6c8ff,#5ea0ff)!important;color:#000!important}
  .chord{outline:3px solid var(--mark);outline-offset:-3px}
  footer{padding:0 14px 18px;color:#666;font-size:13px}
  .status{margin:10px 14px 0;color:#555;font-size:13px}
  .probe{margin-left:auto}
</style>
</head>
<body>
<h1>ðŸŽ¹ Mein Klavier (2 Oktaven, umschaltbar)</h1>

<div class="controls">
  <button id="prevRange" class="btn" title="2-Oktaven-Bereich nach links">âŸµ</button>
  <span id="rangeLabel" class="label">Bereich: C1â€“B2</span>
  <button id="nextRange" class="btn" title="2-Oktaven-Bereich nach rechts">âŸ¶</button>
  <label style="margin-left:8px;"><input id="minor" type="checkbox"> Moll-DreiklÃ¤nge</label>
  <button id="probe" class="btn probe" title="Audio-Test">ðŸ”Š Audio-Probe</button>
</div>
<div class="status" id="status">Bereit.</div>

<div class="board">
  <div class="piano" id="piano">
    <!-- Reihe 1: schwarze Tasten, 2 Oktaven -->
    <div class="row" id="rowBlack">
      <!-- Oktave A: C# D# (leer) F# G# A# | Oktave B: C# D# (leer) F# G# A# -->
      <div class="spacer"></div>
      <button class="key black" data-semi="1">C#</button>
      <button class="key black" data-semi="3">D#</button>
      <div class="spacer"></div>
      <button class="key black" data-semi="6">F#</button>
      <button class="key black" data-semi="8">G#</button>
      <button class="key black" data-semi="10">A#</button>

      <div class="spacer"></div>
      <button class="key black" data-semi="13">C#</button>
      <button class="key black" data-semi="15">D#</button>
      <div class="spacer"></div>
      <button class="key black" data-semi="18">F#</button>
      <button class="key black" data-semi="20">G#</button>
      <button class="key black" data-semi="22">A#</button>
      <div class="spacer"></div>
    </div>

    <!-- Reihe 2: weiÃŸe Tasten, 2 Oktaven (C..B, dann C..B) -->
    <div class="row" id="rowWhite">
      <button class="key white" data-semi="0">C</button>
      <button class="key white" data-semi="2">D</button>
      <button class="key white" data-semi="4">E</button>
      <button class="key white" data-semi="5">F</button>
      <button class="key white" data-semi="7">G</button>
      <button class="key white" data-semi="9">A</button>
      <button class="key white" data-semi="11">B</button>

      <button class="key white" data-semi="12">C</button>
      <button class="key white" data-semi="14">D</button>
      <button class="key white" data-semi="16">E</button>
      <button class="key white" data-semi="17">F</button>
      <button class="key white" data-semi="19">G</button>
      <button class="key white" data-semi="21">A</button>
      <button class="key white" data-semi="23">B</button>
    </div>
  </div>
</div>

<footer>
  Tipp: 2 s Einzeltton â†’ 1 s Pause â†’ 3 s Dreiklang (Grundstellung; Dur/Moll schaltbar).  
  Leise bis moderat Ã¼ben; bei Kratzen â†’ Pause. ðŸ’™
</footer>

<script>
(()=>{
/* ===== Anzeige & Status ===== */
const statusEl = document.getElementById('status');
const log = (msg)=>{ statusEl.textContent = msg; };

/* Root (User-Site): */
const BASE = '/';
/* Dateiendungen, die getestet werden: */
const EXT_CANDIDATES = ['m4a','mp3','mp4','wav'];

/* ===== Bereich: 2 Oktaven ab Cstart â€¦ B(start+1) ===== */
let startOct = 1;                 // Start: C1â€“B2
const LOWEST_START = 1;           // erlaubt: 1 â†’ C1â€“B2
const HIGHEST_START = 2;          // 2 â†’ C2â€“B3 (dafÃ¼r brauchst du Dateien bis B3)
const rangeLabel = document.getElementById('rangeLabel');
const btnPrev = document.getElementById('prevRange');
const btnNext = document.getElementById('nextRange');
function updateRangeLabel(){
  rangeLabel.textContent = `Bereich: C${startOct}â€“B${startOct+1}`;
  btnPrev.disabled = (startOct===LOWEST_START);
  btnNext.disabled = (startOct===HIGHEST_START);
  log(`Bereich gewechselt: C${startOct}â€“B${startOct+1}`);
}
btnPrev.addEventListener('click', ()=>{ if(startOct>LOWEST_START){ startOct--; updateRangeLabel(); }});
btnNext.addEventListener('click', ()=>{ if(startOct<HIGHEST_START){ startOct++; updateRangeLabel(); }});
updateRangeLabel();

/* ===== Namen / Notenberechnung (C1s-Schema) ===== */
const PITCHES = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
function buildNoteName(oct, semi){            // semi: 0..11
  const base = PITCHES[semi];
  return base.includes('#') ? base[0] + oct + 's' : base + oct;
}
/* addiere Halbtonschritte (kann die Oktave verÃ¤ndern) */
function noteFrom(startOctave, semiFromZero, addSemis){
  const total = startOctave*12 + semiFromZero + addSemis;
  const o = Math.floor(total/12);
  let s = total % 12; if(s<0){ s += 12; }     // Sicherheit bei negativen Werten
  return { name: buildNoteName(o, s), oct:o, semi:s };
}

/* ===== Audio-Loader (robust, mit Fallbacks & Ordner-Fallback) ===== */
async function resolveSrc(note){
  const folders = ['samples','Samples']; // falls Ordner groÃŸ geschrieben wurde
  for(const folder of folders){
    for(const ext of EXT_CANDIDATES){
      const url = `${BASE}${folder}/${note}.${ext}`;
      const a = new Audio(url);
      a.preload = 'auto';
      const ok = new Promise(res=>a.addEventListener('canplaythrough', ()=>res(true), {once:true}));
      const err= new Promise(res=>a.addEventListener('error', ()=>res(false), {once:true}));
      const timed = Promise.race([ok,err,new Promise(res=>setTimeout(()=>res(false),1200))]);
      const canPlay = await timed;
      if(canPlay){ return url; }
    }
  }
  return null;
}

async function playSample(note, durSec=2.0){
  const src = await resolveSrc(note);
  if(!src){ log(`âš ï¸ Datei fehlt: ${note}`); return null; }
  log(`â–¶ï¸Ž ${note} â€“ ${src.split('/').slice(-2).join('/')}`);
  const a = new Audio(src);
  a.preload = 'auto';
  a.playsInline = true;
  a.currentTime = 0;
  a.play().catch(()=>{});
  if(durSec>0){
    setTimeout(()=>{ try{ a.pause(); a.remove(); }catch(e){} }, Math.round(durSec*1000));
  }
  return a;
}

/* ===== UI / Tasten & Feedback ===== */
const minor = document.getElementById('minor');
function flash(el, cls, ms){ el.classList.add(cls); setTimeout(()=>el.classList.remove(cls), ms); }
function keyElsForSemis(semiList){
  return semiList.map(semi => document.querySelector(`.key[data-semi="${semi}"]`)).filter(Boolean);
}

/* ===== Klick-Ablauf: Note 2s â†’ Pause 1s â†’ Akkord 3s (gleichzeitig) ===== */
const busy = new Set();

document.body.addEventListener('click', async (e)=>{
  const btn = e.target.closest('.key');
  if(!btn) return;

  const semiFromRangeStart = parseInt(btn.dataset.semi, 10);  // 0..23
  if(busy.has(semiFromRangeStart)) return;
  busy.add(semiFromRangeStart);

  // Grundton absolut (Oktave = startOct + evtl. +1)
  const absRoot = noteFrom(startOct, semiFromRangeStart, 0);  // {name,oct,semi}

  // 1) Einzeltton 2 s
  flash(btn,'active',400);
  await playSample(absRoot.name, 2.0);

  // 2) Pause 1 s, dann 3) Dreiklang 3 s (Grundstellung, simultan)
  setTimeout(async ()=>{
    const isMinor = minor && minor.checked;
    const intervals = isMinor ? [0,3,7] : [0,4,7];             // Grundstellung
    // AkkordtÃ¶ne absolut berechnen (kann in nÃ¤chste Oktave springen)
    const chordNotes = intervals.map(semiAdd => noteFrom(absRoot.oct, absRoot.semi, semiAdd).name);
    // Visuell markieren: lokale Semis (modulo 24 auf den sichtbaren Bereich abbilden)
    const localSemis = intervals.map(semiAdd => (semiFromRangeStart + semiAdd));
    keyElsForSemis(localSemis.map(s=>s%24)).forEach(k=>flash(k,'chord',1000));
    // Alle 3 gleichzeitig starten (3 s)
    chordNotes.forEach(n => playSample(n, 3.0));
    setTimeout(()=>busy.delete(semiFromRangeStart), 3100);
  }, 1000);
});
/* ===== Audio-Probe (spielt C der linken Oktave kurz an) ===== */
document.getElementById('probe').addEventListener('click', async ()=>{
  const test = buildNoteName(startOct, 0); // Cstart
  await playSample(test, 1.2);
});
})();
</script>
</body>
</html>
